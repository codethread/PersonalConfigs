#!/bin/zsh
# vim:fileencoding=utf-8:foldmethod=marker:foldlevel=0
# setup PATH
# set this up globally on mac for gui apps too

#: Helpers {{{
# some ideas on this at: https://bitbucket.org/flowblok/shell-startup/src/default/.shell/env_functions
# and https://blog.flowblok.id.au/2013-02/shell-startup-scripts.html

# Usage: indirect_expand PATH -> $PATH
indirect_expand () {
    env |sed -n "s/^$1=//p"
}

# Usage: pathremove /path/to/bin [PATH]
# Eg, to remove ~/bin from $PATH
#     pathremove ~/bin PATH
pathremove () {
    local IFS=':'
    local newpath
    local dir
    local var=${2:-PATH}
    # Bash has ${!var}, but this is not portable.
    for dir in `indirect_expand "$var"`; do
        IFS=''
        if [ "$dir" != "$1" ]; then
            newpath=$newpath:$dir
        fi
    done
    export $var=${newpath#:}
}

# Usage: pathprepend /path/to/bin [PATH]
# Eg, to prepend ~/bin to $PATH
#     pathprepend ~/bin PATH
pathprepend () {
    # if the path is already in the variable,
    # remove it so we can move it to the front
    pathremove "$1" "$2"
    #[ -d "${1}" ] || return
    local var="${2:-PATH}"
    local value=`indirect_expand "$var"`
    export ${var}="${1}${value:+:${value}}"
}

# Usage: pathappend /path/to/bin [PATH]
# Eg, to append ~/bin to $PATH
#     pathappend ~/bin PATH
pathappend () {
    pathremove "${1}" "${2}"
    #[ -d "${1}" ] || return
    local var=${2:-PATH}
    local value=`indirect_expand "$var"`
    export $var="${value:+${value}:}${1}"
}
#: }}}

#: Mac only {{{

if [ "$(uname 2> /dev/null)" != "Linux" ]; then
  [ -d "/usr/local/opt/python/libexec/bin" ] && pathprepend "/usr/local/opt/python/libexec/bin" PATH
fi

#: }}}
#: Linux only {{{

if [ "$(uname 2> /dev/null)" = "Linux" ]; then
  [ -d "/opt/X12/bin" ] && pathprepend "/opt/X12/bin" PATH
  [ -d "/opt/local/bin" ] && pathprepend "/opt/local/bin" PATH
fi

#: }}}
#: Personal shared {{{

[ -d "$HOME/.local/bin" ] && pathprepend "$HOME/.local/bin" PATH
[ -d "$HOME/.emacs.d/bin" ] && pathprepend "$HOME/.emacs.d/bin" PATH

#: }}}
#: Homebrew {{{

  if [ -d "/usr/local/bin" ]; then
    export BREW_PATH="/usr/local"
  fi

  if [ -d "/opt/homebrew/bin" ]; then
    export BREW_PATH="/opt/homebrew"
  fi

    pathprepend "$BREW_PATH/bin" PATH
    pathprepend "$BREW_PATH/sbin" PATH

  # use gnu coreutils instead of mac, e.g sed
  # this actually messed with a lot of packages that expected the defaults
  # pathprepend "$BREW_PATH/opt/coreutils/libexec/gnubin" PATH
  # pathprepend "$BREW_PATH/opt/gnu-sed/libexec/gnubin" PATH
  # pathprepend "$BREW_PATH/opt/gnu-tar/libexec/gnubin" PATH

#: }}}
#: node {{{

[ -d "$VOLTA_HOME/bin" ] && pathprepend "$VOLTA_HOME/bin" PATH

#: }}}
#: Golang {{{

[ -d "$GOBIN" ] && pathprepend "$GOBIN" PATH
[ -d "/usr/local/go/bin" ] && pathprepend "/usr/local/go/bin" PATH

#: }}}
#: rust {{{

[ -d "$HOME/.cargo/bin" ] && pathprepend "$HOME/.cargo/bin" PATH

#: }}}
#: lua {{{

[ -d "$HOME/.luarocks/bin" ] && pathprepend "$HOME/.luarocks/bin" PATH

#: }}}
#: misc {{{

[ -d "$HOME/istio-1.5.1/bin" ] && pathprepend "$HOME/istio-1.5.1/bin" PATH

#: }}}
#: unity {{{

[ -d "$HOME/.dotnet/tools" ] && pathprepend "$HOME/.dotnet/tools" PATH
[ -d "/usr/local/share/dotnet" ] && pathprepend "/usr/local/share/dotnet" PATH

if [ "$(uname 2> /dev/null)" != "Linux" ]; then
  [ -d "/Library/Frameworks/Mono.framework/Versions/Current/Commands" ] && pathprepend "/Library/Frameworks/Mono.framework/Versions/Current/Commands" PATH
fi

#: }}}
#: jvm java {{{

[ -d "$HOME/.jenv/bin" ] && pathprepend "$HOME/.jenv/bin" PATH
[ -d "$HOME/.jenv/shims" ] && pathprepend "$HOME/.jenv/shims" PATH

#: }}}
#: ruby {{{

[ -d "$HOME/.rbenv/shims" ] && pathprepend "$HOME/.rbenv/shims" PATH

#: }}}

#: Save to /etc/paths {{{

echo "new path: at /etc/paths"
echo $PATH | tr -s ':' '\n'

mkdir -p "$HOME/.config/envy"
# backup old version
cat /etc/paths > "$HOME/.config/envy/$(date +%s)"
sudo echo $PATH > /etc/paths

#: }}}
