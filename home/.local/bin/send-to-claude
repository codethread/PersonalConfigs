#!/bin/bash
# :module: Sends text to a Claude window in the current kitty tab
# send-to-claude - Validate and send text to the Claude window in the current tab

if [ -z "$KITTY_WINDOW_ID" ]; then
  echo "Error: KITTY_WINDOW_ID not set, must run inside kitty" >&2
  exit 1
fi

CHECK_ONLY=false
CLAUDE_ID=""
TEXT=""

for arg in "$@"; do
  case "$arg" in
    --check)  CHECK_ONLY=true ;;
    --id=*)   CLAUDE_ID="${arg#--id=}" ;;
    *)        TEXT="$arg" ;;
  esac
done

# If --id provided, skip discovery and send directly
if [ -n "$CLAUDE_ID" ]; then
  if [ -z "$TEXT" ]; then
    echo "Error: no text provided" >&2
    exit 1
  fi
  kitty @ send-text --match "id:$CLAUDE_ID" "$TEXT"
  kitty @ send-text --match "id:$CLAUDE_ID" $'\r'
  exit 0
fi

# Discover Claude window in current tab
KITTY_DATA=$(kitty @ ls 2>/dev/null)
if [ $? -ne 0 ]; then
  echo "Error: kitty remote control unavailable" >&2
  exit 1
fi

JQ_FILTER='
  [.[].tabs[] | select(.windows[]?.id == '$KITTY_WINDOW_ID')] | .[0] as $tab |
  if $tab == null then error("current tab not found")
  else
    [$tab.windows[] | select(.foreground_processes[]?.cmdline[]? | test("/claude$"))] as $wins |
    { count: ($wins | length), id: ($wins[0].id // null) }
  end
'
RESULT=$(echo "$KITTY_DATA" | jq -e "$JQ_FILTER" 2>/dev/null)
if [ $? -ne 0 ]; then
  echo "Error: Could not find current tab" >&2
  exit 1
fi

COUNT=$(echo "$RESULT" | jq '.count')
FOUND_ID=$(echo "$RESULT" | jq -r '.id // "null"')

if [ "$COUNT" -eq 0 ]; then
  echo "Error: No Claude windows in current tab" >&2
  exit 1
fi

if [ "$COUNT" -gt 1 ]; then
  echo "Error: Found $COUNT Claude windows in current tab, expected 1" >&2
  exit 1
fi

if [ "$FOUND_ID" = "null" ]; then
  echo "Error: Could not determine Claude window ID" >&2
  exit 1
fi

# --check: print the window ID and exit for caller to capture
if [ "$CHECK_ONLY" = true ]; then
  echo "$FOUND_ID"
  exit 0
fi

if [ -z "$TEXT" ]; then
  echo "Error: no text provided" >&2
  exit 1
fi

kitty @ send-text --match "id:$FOUND_ID" "$TEXT"
kitty @ send-text --match "id:$FOUND_ID" $'\r\r'
