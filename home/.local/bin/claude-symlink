#!/bin/bash
# :module: Create CLAUDE.md symlinks pointing to AGENTS.md files

set -euo pipefail

show_help() {
  cat << EOF
Usage: $(basename "$0") [OPTIONS]

Create CLAUDE.md symlinks pointing to AGENTS.md files in the repository.

OPTIONS:
  -h, --help     Show this help message
  -n, --dry-run  Show what would be done without making changes

EXAMPLES:
  $(basename "$0")           # Create symlinks for all AGENTS.md files
  $(basename "$0") --dry-run # Preview changes without creating symlinks
EOF
}

dry_run=false

while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help)
      show_help
      exit 0
      ;;
    -n|--dry-run)
      dry_run=true
      shift
      ;;
    *)
      echo "Unknown option: $1" >&2
      show_help >&2
      exit 1
      ;;
  esac
done

# Find all AGENTS.md files
agents_files=$(rg --files | rg 'AGENTS\.md$' || true)

if [[ -z "$agents_files" ]]; then
  echo "No AGENTS.md files found"
  exit 0
fi

while IFS= read -r agents_file; do
  dir=$(dirname "$agents_file")
  claude_file="$dir/CLAUDE.md"

  if [[ "$dry_run" == true ]]; then
    echo "Would create: $claude_file -> AGENTS.md"
  else
    # Create symlink (remove existing file/symlink first if it exists)
    if [[ -e "$claude_file" ]] || [[ -L "$claude_file" ]]; then
      rm "$claude_file"
    fi
    ln -s "AGENTS.md" "$claude_file"
    echo "Created: $claude_file -> AGENTS.md"
  fi
done <<< "$agents_files"