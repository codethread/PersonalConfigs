#!/usr/bin/env bash
# :module: audio--stop-recording
# Send stop signal to audio recording process

set -euo pipefail

PID_FILE="/tmp/audio-recording.pid"

# Check if PID file exists
if [[ ! -f "$PID_FILE" ]]; then
    echo "Error: No recording in progress (PID file not found)" >&2
    exit 1
fi

# Read PID from file
PID=$(cat "$PID_FILE")

# Validate PID is a number
if ! [[ "$PID" =~ ^[0-9]+$ ]]; then
    echo "Error: Invalid PID in file: $PID" >&2
    exit 1
fi

# Check if process exists
if ! kill -0 "$PID" 2>/dev/null; then
    echo "Error: Process $PID not found" >&2
    rm -f "$PID_FILE"
    exit 1
fi

# Send SIGUSR1 to stop and transcribe
if kill -USR1 "$PID" 2>/dev/null; then
    echo "Stop signal sent to recording process (PID: $PID)" >&2
    exit 0
else
    echo "Error: Failed to send signal to process $PID" >&2
    exit 1
fi
