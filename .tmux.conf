#-------------------------------------------------------------------------------------------------``
#--- Global
#--------------------------------------------------------------------------------------------------
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'

set -s escape-time 10
# set -sg repeat-time 400                   # allow moving between panes quicker, turned off while using prefixless pane movement
set -g history-limit 5000                 # boost history

set -g mouse on
set -g set-titles on          # set terminal title

unbind C-b
set-option -g prefix C-a
bind-key C-a send-prefix

set -g base-index 1           # start windows numbering at 1

bind r command-prompt -p "Rename Session:" "rename-session '%%'"

# VI like
set-window-option -g mode-keys vi
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'y' send -X copy-selection-and-cancel

# set -g @menus_trigger 'x'
# set -g @menus_location_x 'C'
# set -g @menus_location_y 'C'
# set -g @plugin 'jaclu/tmux-menus' -- this is nice, but don't have much need for now

# TMUX_FZF_SESSION_FORMAT
# TMUX_FZF_WINDOW_FORMAT
# TMUX_FZF_LAUNCH_KEY="C-f"
TMUX_FZF_LAUNCH_KEY="\\;"
TMUX_FZF_PANE_FORMAT="#{window_index}.#{pane_index} #{?window_active,+,}#{window_name} - #{pane_current_command} #{pane_current_path}"
set -g @plugin 'sainnhe/tmux-fzf'

#-------------------------------------------------------------------------------------------------``
#--- Session
#--------------------------------------------------------------------------------------------------
# change 'project'
bind-key "p" run-shell -b "~/.tmux/plugins/tmux-fzf/scripts/session.sh attach"

# create session
bind N command-prompt -p "New Session:" "new-session -s '%%' -n main"

bind -r BTab switch-client -l  # move to last session

#-------------------------------------------------------------------------------------------------``
#--- Window
#--------------------------------------------------------------------------------------------------
setw -g automatic-rename on   # rename window to reflect current program
set -g renumber-windows on    # renumber windows when a window is closed
set -g main-pane-width 60% # good for default main layout (bound to C-=)

bind n new-window -c "#{pane_current_path}"

# 'list' windows
bind "l" run-shell -b "~/.tmux/plugins/tmux-fzf/scripts/window.sh switch"

# override terminal to send these, they could actually be anything really
bind -n -r C-M-[ previous-window # select previous window
bind -n -r C-M-] next-window # select previous window
bind -r Tab last-window        # move to last active window

#-------------------------------------------------------------------------------------------------``
#--- Pane
#--------------------------------------------------------------------------------------------------
setw -g pane-base-index 1     # make pane numbering consistent with windows

bind Space resize-pane -Z # zoom pane
bind = select-layout main-vertical # reset layout to my prefered |-

# pane movement
set -g @plugin 'christoomey/vim-tmux-navigator' # move between vim/tmux smoothly
# bind -r h select-pane -L
# bind -r j select-pane -D
# bind -r k select-pane -U
# bind -r l select-pane -R

# pane resizing
bind -r H resize-pane -L 2
bind -r J resize-pane -D 2
bind -r K resize-pane -U 2
bind -r L resize-pane -R 2

# split panes using | and -
unbind '"'
unbind %
bind -r - split-window -c "#{pane_current_path}"
bind -r | split-window -h -c "#{pane_current_path}"


# 'join' another pane, swapping it for another
bind-key "j" run-shell -b "~/.tmux/plugins/tmux-fzf/scripts/pane.sh swap"
# bind-key u command-prompt -p "join pane from:"  "swap-pane -t '%%'"

# dismiss current pane
bind-key b break-pane -d

set -g @fuzzback-popup 1
set -g @plugin 'roosta/tmux-fuzzback' # prefix + ? to fzf history

# set -g @jump-key 's'
# set -g @plugin 'schasse/tmux-jump'

#-------------------------------------------------------------------------------------------------``
#--- UI
#--------------------------------------------------------------------------------------------------
# TODO: one day sort this out
set -g default-terminal "xterm-256color-italic"
set-option -ga terminal-overrides ',*:enacs@:smacs@:rmacs@:acsc@'
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # undercurl support
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # underscore colours - needs tmux-3.0

# The modes
setw -g clock-mode-colour colour135
setw -g mode-style fg=colour209,bg=colour08,bold

# The panes
set -g pane-border-style bg="default",fg="#686868"
set -g pane-active-border-style bg="default",fg="blue"

#-------------------------------------------------------------------------------------------------``
#--- STATUS LINE
#--------------------------------------------------------------------------------------------------
set -g status-justify left
set -g status-interval 2 # frequency in seconds of refresh
set -g status-position bottom
set -g status-justify centre
set -g status-style bg="default",fg="blue"

set -g @cpu_low_fg_color "#[fg=#686868]"
set -g @cpu_medium_fg_color "#[fg=yellow]"
set -g @cpu_high_fg_color "#[fg=red]"

set -g @batt_color_full_charge "#[fg=cyan]"
set -g @batt_color_high_charge "#[fg=green]"
set -g @batt_color_medium_charge "#[fg=yellow]"
set -g @batt_color_low_charge "#[fg=red]"

STATUS_CURRENT_='#[fg=blue,bold]#{?client_prefix,#[fg=yellow],} #[fg=black,bg=blue]#{?client_prefix,#[bg=yellow],} #S #[fg=blue,bg=default]#{?client_prefix,#[fg=yellow],} '
STATUS_BATTERY_='#[fg=blue,bg=default]#{battery_status_fg}♥ #{battery_percentage}'
STATUS_CPU_='#{cpu_fg_color}☀ #{cpu_percentage} '

STATUS_DATE_='#{?client_prefix,#[fg=yellow],} %H:%M:%S | %A %d %b  '

set -g status-right-length 100
set -g status-left-length 100

set -g status-left $STATUS_CURRENT_$STATUS_BATTERY_$STATUS_CPU_$STATUS_POMO_
set -g status-right $STATUS_DATE_

# window status
set -g window-status-current-format "#[fg=cyan, bold] #I: #W#{?window_zoomed_flag,#[bold]+,}"
set -g window-status-format "#[fg=blue] #I: #W#{?window_zoomed_flag,#[bold]+,}"

set -g window-status-bell-style fg=colour255,bg=colour1,bold

# The messages
set -g message-command-style fg=cyan,bg=default
set -g message-style fg="blue",bg="default",bold

set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'tmux-plugins/tmux-battery'

#-------------------------------------------------------------------------------------------------``
#--- PLUGINS
#--------------------------------------------------------------------------------------------------
# C-s to save C-r to reload
set -g @plugin 'tmux-plugins/tmux-resurrect' 
# automatically saves and loades resurrect sesisons
# needs to come last to use the status-right variable
set -g @plugin 'tmux-plugins/tmux-continuum' 
set -g @continuum-boot 'on' # start up tmux on boot
set -g @continuum-boot-options 'iterm'
set -g @continuum-restore 'on' # reload last session
set -g @continuum-save-interval '15'
set -g @resurrect-strategy-nvim 'session'

# set -g @plugin 'wfxr/tmux-fzf-url' # prefix + u to fzf urls

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"
run '~/.tmux/plugins/tpm/tpm'
